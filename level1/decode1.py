from PIL import Image
import numpy as np
import zlib
import itertools

def flatten_image(image):
    newarray = []
    num = 0
    for j in range(len(image[0])):
        for i in range(len(image)):
            r = (0b00000111 & image[i][j][0])
            g = (0b00000111 & image[i][j][1]) << 3
            b = (0b00000011 & image[i][j][2]) << 6
            newarray.append(r | g | b)
    return bytes(newarray)


def xor(flattened_image, key):
    newarray = [b ^ key[i % len(key)] for i, b in enumerate(flattened_image)]
    return bytes(newarray)
    

def main():
    image = np.asarray(Image.open('mb_logo_star.png')) # 700 x 700 x 3
    flattened_image = flatten_image(image)
    decoded = xor(flattened_image, b'easy_level_one_almost_done_xor_pe_and_keep_going!')[:241152]
    open('level2_decoded.exe', 'wb').write(decoded)
    print(hex(zlib.crc32(decoded))) # 2741486452


if __name__ == '__main__':
    main()
    